name: Backfill (2 weeks)

on:
  workflow_dispatch:
    inputs:
      week_end_1:
        description: "First week ending date (YYYY-MM-DD)"
        required: true
        type: string
      week_end_2:
        description: "Second week ending date (YYYY-MM-DD)"
        required: true
        type: string
      regime:
        description: "Regime ID"
        required: true
        default: "news-novelty-v1"
        type: string
      schema:
        description: "Schema ID"
        required: true
        default: "news-novelty-v1b"
        type: string
      universe:
        description: "Universe CSV path"
        required: true
        default: "sp500_universe.csv"
        type: string
      from_stage:
        description: "Start from stage (candles|news|cluster|enrich|score|report|basket|trader|log)"
        required: true
        default: "candles"
        type: string
      force:
        description: "Force rebuild artifacts"
        required: true
        default: true
        type: boolean

concurrency:
  group: backfill-${{ github.ref }}
  cancel-in-progress: false

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Preflight require API keys
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${FINNHUB_API_KEY:-}" ]; then
            echo "Missing FINNHUB_API_KEY secret"
            exit 1
          fi
          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "Missing OPENAI_API_KEY secret"
            exit 1
          fi
          echo "âœ… API keys present"

      - name: Run weekly pipeline (week_end_1)
        shell: bash
        run: |
          set -euxo pipefail
          WEEK="${{ inputs.week_end_1 }}"
          echo "=== Running week_end=${WEEK} ==="
          echo "${WEEK}" > week_end.txt
          echo "week_end.txt now:"
          cat week_end.txt

          test "$(cat week_end.txt)" = "${WEEK}"

          FORCE_FLAG=""
          if [[ "${{ inputs.force }}" == "true" ]]; then
            FORCE_FLAG="--force"
          fi

          python -m src.run_weekly_pipeline \
            --week_end "${WEEK}" \
            --universe "${{ inputs.universe }}" \
            --regime "${{ inputs.regime }}" \
            --schema "${{ inputs.schema }}" \
            --from_stage "${{ inputs.from_stage }}" \
            ${FORCE_FLAG}

          echo "=== Verify expected artifacts exist for ${WEEK} ==="
          test -f "data/derived/rep_enriched/week_ending=${WEEK}/rep_enriched.parquet"
          test -f "data/derived/features_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${WEEK}/features_weekly.parquet"
          test -f "data/derived/scores_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${WEEK}/scores_weekly.parquet"

      - name: Upload derived artifacts (week_end_1)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: derived-${{ inputs.week_end_1 }}
          if-no-files-found: warn
          path: |
            data/derived/rep_enriched/week_ending=${{ inputs.week_end_1 }}/
            data/derived/features_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_1 }}/
            data/derived/scores_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_1 }}/
            data/derived/reports/week_ending=${{ inputs.week_end_1 }}/
            
      - name: Clean derived artifacts for week_end_2
        shell: bash
        run: |
          set -euxo pipefail
          WEEK="${{ inputs.week_end_2 }}"
          echo "ðŸ§¹ Cleaning derived artifacts for ${WEEK}"
          rm -rf \
            data/derived/rep_enriched/week_ending=${WEEK} \
            data/derived/features_weekly/**/week_ending=${WEEK} \
            data/derived/scores_weekly/**/week_ending=${WEEK} \
            data/derived/reports/week_ending=${WEEK} \
            data/derived/baskets/week_ending=${WEEK} \
            data/derived/trader_sheets/week_ending=${WEEK}

      - name: Run weekly pipeline (week_end_2)
        shell: bash
        run: |
          set -euxo pipefail
          WEEK="${{ inputs.week_end_2 }}"
          echo "=== Running week_end=${WEEK} ==="

          # âœ… satisfy week_end mismatch guard
          echo "${WEEK}" > week_end.txt
          echo "week_end.txt now:"
          cat week_end.txt
          
          test "$(cat week_end.txt)" = "${WEEK}"

          FORCE_FLAG=""
          if [[ "${{ inputs.force }}" == "true" ]]; then
            FORCE_FLAG="--force"
          fi

          python -m src.run_weekly_pipeline \
            --week_end "${WEEK}" \
            --universe "${{ inputs.universe }}" \
            --regime "${{ inputs.regime }}" \
            --schema "${{ inputs.schema }}" \
            --from_stage "news" \
            ${FORCE_FLAG}

          echo "=== Verify expected artifacts exist for ${WEEK} ==="
          test -f "data/derived/rep_enriched/week_ending=${WEEK}/rep_enriched.parquet"
          test -f "data/derived/features_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${WEEK}/features_weekly.parquet"
          test -f "data/derived/scores_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${WEEK}/scores_weekly.parquet"

      - name: Upload derived artifacts (week_end_2)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: derived-${{ inputs.week_end_2 }}
          if-no-files-found: warn
          path: |
            data/derived/rep_enriched/week_ending=${{ inputs.week_end_2 }}/
            data/derived/features_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_2 }}/
            data/derived/scores_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_2 }}/
            data/derived/reports/week_ending=${{ inputs.week_end_2 }}/


      - name: Upload derived artifacts (both weeks)
        uses: actions/upload-artifact@v4
        with:
          name: derived-backfill-${{ inputs.week_end_1 }}-${{ inputs.week_end_2 }}
          if-no-files-found: error
          path: |
            data/derived/rep_enriched/week_ending=${{ inputs.week_end_1 }}/
            data/derived/features_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_1 }}/
            data/derived/scores_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_1 }}/

            data/derived/rep_enriched/week_ending=${{ inputs.week_end_2 }}/
            data/derived/features_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_2 }}/
            data/derived/scores_weekly/regime=${{ inputs.regime }}/schema=${{ inputs.schema }}/week_ending=${{ inputs.week_end_2 }}/