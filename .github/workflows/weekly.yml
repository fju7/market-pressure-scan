name: Weekly Market Pressure Scan

on:
  schedule:
    - cron: "5 21 * * 5"  # 4:05pm ET (Fridays at 21:05 UTC during EST)
  workflow_dispatch: {}

concurrency:
  group: market-pressure-scan
  cancel-in-progress: true

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Guard - only proceed at 4:05pm ET (scheduled only)
        run: |
          python - <<'PY'
          import datetime as dt
          from zoneinfo import ZoneInfo
          import os

          event = os.environ.get("GITHUB_EVENT_NAME", "")
          if event != "schedule":
              print("Not a scheduled run; skipping time guard.")
              raise SystemExit(0)

          now = dt.datetime.now(ZoneInfo("America/New_York"))
          if not (now.weekday() == 4 and now.hour == 16 and now.minute == 5):
              print(f"Not 4:05pm ET Friday (now={now}). Exiting successfully.")
              raise SystemExit(0)

          print(f"Guard passed: now={now}")
          PY
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Verify required secrets present
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          test -n "${FINNHUB_API_KEY}" || (echo "âŒ FINNHUB_API_KEY secret missing" && exit 1)
          test -n "${OPENAI_API_KEY}" || (echo "âŒ OPENAI_API_KEY secret missing" && exit 1)
          echo "âœ“ Required secrets present"

      - name: Universe sanity check
        run: |
          echo "UNIVERSE PATH: sp500_universe.csv"
          wc -l sp500_universe.csv
          echo "---"
          head -5 sp500_universe.csv
          echo "..."
          tail -3 sp500_universe.csv

      - name: Compute week_end (today if Friday else last Friday, ET)
        id: week_end
        run: |
          python - <<'PY'
          import datetime as dt
          from zoneinfo import ZoneInfo

          today = dt.datetime.now(ZoneInfo("America/New_York")).date()
          # Monday=0 ... Friday=4
          if today.weekday() == 4:
              week_end = today
          else:
              days_since_fri = (today.weekday() - 4) % 7
              week_end = today - dt.timedelta(days=days_since_fri)

          print("week_end =", week_end.isoformat())
          with open("week_end.txt", "w") as f:
              f.write(week_end.isoformat())
          PY

      - name: Run weekly pipeline
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          WEEK_END=$(cat week_end.txt)
          python -m src.run_weekly_pipeline --week_end "$WEEK_END" --max_clusters_per_symbol 1 --skip_backtest
          python -m src.update_weekly_pnl --week_end "$WEEK_END"
          python -m src.scoreboard
          python -m src.trader_sheet --week_end "$WEEK_END"
          python -m src.log_week_decision --week_end "$WEEK_END"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trader-sheet-and-report
          path: |
            data/derived/trader_sheets/**
            data/derived/reports/**
            data/derived/baskets/**
            data/live/scoreboard.csv

      - name: Create notification issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const week_end = fs.readFileSync('week_end.txt', 'utf8').trim();
            const status = '${{ job.status }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            // Read scoreboard
            let scoreboardSnippet = 'Scoreboard not available';
            try {
              const scoreboard = fs.readFileSync('data/live/scoreboard.csv', 'utf8');
              const lines = scoreboard.split('\n').slice(0, 10);
              scoreboardSnippet = '```\n' + lines.join('\n') + '\n```';
            } catch (e) {
              scoreboardSnippet = 'Could not read scoreboard';
            }
            
            // Read basket for action + top symbols (canonical source)
            let actionDecision = 'UNKNOWN';
            let topSymbols = 'Not available';
            let basketSize = 0;
            let overlapPct = null;
            let turnoverPct = null;
            
            try {
              const basketPath = `data/derived/baskets/week_ending=${week_end}/basket.csv`;
              const basketCsv = fs.readFileSync(basketPath, 'utf8').trim();
              const rows = basketCsv.split('\n').filter(r => r.trim().length > 0);
              
              // Parse header to find column indices
              const header = rows[0].split(',');
              const actionIdx = header.indexOf('action');
              const reasonIdx = header.indexOf('reason');
              const symbolIdx = header.indexOf('symbol');
              const upsIdx = header.indexOf('UPS_adj');
              const convictionIdx = header.indexOf('conviction');
              
              // Parse first data row to read action
              const firstRow = rows[1]?.split(',') || [];
              const action = actionIdx >= 0 ? (firstRow[actionIdx] || '').trim() : '';
              
              if (action === 'SKIP') {
                actionDecision = 'â¸ï¸ SKIP';
                const reason = reasonIdx >= 0 ? (firstRow[reasonIdx] || '').trim() : 'Low-information week';
                topSymbols = reason || 'Low-information week';
                basketSize = 0;
              } else {
                actionDecision = 'ðŸ“ˆ TRADE';
                
                // Count symbol rows (exclude header)
                const symbolRows = rows.slice(1).filter(r => r.trim());
                basketSize = symbolRows.length;
                
                // Top 5 from file order (already ranked by UPS)
                const top5 = symbolRows.slice(0, 5).map(r => {
                  const cols = r.split(',');
                  const ticker = symbolIdx >= 0 ? (cols[symbolIdx] || '?').trim() : '?';
                  const ups = upsIdx >= 0 ? (cols[upsIdx] || '?').trim() : '?';
                  const conviction = convictionIdx >= 0 ? (cols[convictionIdx] || '?').trim() : '?';
                  return `${ticker} (UPS: ${ups}, ${conviction})`;
                });
                
                topSymbols = top5.join('\n');
              }
            } catch (e) {
              topSymbols = `Could not read basket: ${e.message}`;
            }
            
            // Read weeks_log for turnover metrics
            try {
              const weeksLog = fs.readFileSync('data/live/weeks_log.csv', 'utf8');
              const lines = weeksLog.split('\n');
              const currentWeekLine = lines.find(line => line.includes(week_end));
              
              if (currentWeekLine) {
                const cols = currentWeekLine.split(',');
                // Assuming CSV columns: week_ending_date,action,basket_size,overlap_pct,turnover_pct,...
                basketSize = parseInt(cols[2]) || basketSize;
                overlapPct = parseFloat(cols[3]);
                turnoverPct = parseFloat(cols[4]);
              }
            } catch (e) {
              // Weeks log might not exist yet or metric not available
            }
            
            const body = `@fju7 â€” Your weekly market pressure scan is ready!
            
            ## ðŸ“Š Weekly Market Pressure Scan Complete
            
            **Week Ending:** ${week_end}
            **Status:** ${status === 'success' ? 'âœ… Success' : 'âŒ Failed'}
            **Basket Size:** ${basketSize}${overlapPct !== null ? `\n**Overlap:** ${overlapPct.toFixed(1)}% | **Turnover:** ${turnoverPct.toFixed(1)}%` : ''}
            
            ### ${actionDecision}
            
            **Top 5 UPS Signals:**
            \`\`\`
            ${topSymbols}
            \`\`\`
            
            ### Quick Stats
            ${scoreboardSnippet}
            
            ### ðŸ”— Links
            - **[ðŸ“¥ View Run & Download Artifacts](${runUrl})**
            - Artifacts include: Trader Sheet, Weekly Report, Basket, Scoreboard
            
            ---
            *This issue auto-closes in 7 days*`;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“ˆ Weekly Scan: ${week_end}`,
              body: body,
              labels: ['weekly-scan', 'automated']
            });
            
            // Schedule auto-close in 7 days
            const closeDate = new Date();
            closeDate.setDate(closeDate.getDate() + 7);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `ðŸ¤– This issue will auto-close on ${closeDate.toISOString().split('T')[0]}`
            });
            
            // Return issue number for potential auto-close step
            return issue.data.number;

      - name: Schedule issue auto-close
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const week_end = fs.readFileSync('week_end.txt', 'utf8').trim();
            
            // Find the issue we just created
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'weekly-scan',
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              const issue = issues.data[0];
              const createdDate = new Date(issue.created_at);
              const now = new Date();
              const daysOld = (now - createdDate) / (1000 * 60 * 60 * 24);
              
              // Close issues older than 7 days
              const oldIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'weekly-scan',
                state: 'open',
                per_page: 100
              });
              
              for (const oldIssue of oldIssues.data) {
                const created = new Date(oldIssue.created_at);
                const age = (now - created) / (1000 * 60 * 60 * 24);
                
                if (age >= 7) {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: oldIssue.number,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: oldIssue.number,
                    body: 'ðŸ¤– Auto-closed after 7 days'
                  });
                }
              }
            }
