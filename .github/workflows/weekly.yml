name: Weekly Market Pressure Scan

on:
  schedule:
    # Run at 6:35pm New York time year-round (23:35 UTC Friday; guard handles DST)
    - cron: "35 23 * * 5"
  workflow_dispatch:
    inputs:
      week_end:
        description: "Week ending date (YYYY-MM-DD). Leave blank to auto-compute."
        required: false
        default: ""

concurrency:
  group: market-pressure-scan-${{ github.ref }}-${{ github.event_name }}-${{ github.event.inputs.week_end || 'auto' }}
  cancel-in-progress: ${{ github.event_name == 'schedule' }}

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    env:
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

    outputs:
      week_end: ${{ steps.week_end.outputs.week_end }}
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12" 
      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Guard - only proceed at 6:35pm ET Friday (scheduled only)
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          python - <<'PY'
          import datetime as dt
          from zoneinfo import ZoneInfo
          import os

          event = os.environ.get("GITHUB_EVENT_NAME", "")
          if event == "schedule":
              now = dt.datetime.now(ZoneInfo("America/New_York"))
              if not (now.weekday() == 4 and now.hour == 18 and now.minute == 35):
                  print(f"Not 6:35pm ET Friday (now={now}). Exiting successfully.")
                  raise SystemExit(0)
              print(f"Guard passed for scheduled run: now={now}")
          else:
              print(f"Manual run (event={event}), bypassing time guard. Proceeding.")
          PY

      - name: Universe sanity check
        run: |
          set -euo pipefail
          echo "UNIVERSE PATH: sp500_universe.csv"
          test -f sp500_universe.csv || (echo "❌ sp500_universe.csv missing at repo root" && exit 1)
          wc -l sp500_universe.csv
          echo "---"
          head -5 sp500_universe.csv
          echo "..."
          tail -3 sp500_universe.csv

      - name: Determine week_end
        id: week_end
        shell: bash
        run: |
          set -euo pipefail
          WEEK_END="${{ github.event.inputs.week_end }}"

          if [ -z "$WEEK_END" ]; then
            WEEK_END=$(python - <<'PY'
          import datetime as dt
          from zoneinfo import ZoneInfo
          today = dt.datetime.now(ZoneInfo("America/New_York")).date()
          if today.weekday() == 4:
              week_end = today
          else:
              days_since_fri = (today.weekday() - 4) % 7
              week_end = today - dt.timedelta(days=days_since_fri)
          print(week_end.isoformat())
          PY
          )
          fi

          python - <<PY
          import sys, datetime as dt
          s = "${WEEK_END}"
          try:
              dt.date.fromisoformat(s)
          except Exception:
              print(f"Invalid week_end: {s!r} (expected YYYY-MM-DD)", file=sys.stderr)
              sys.exit(2)
          PY

          echo "$WEEK_END" > "$GITHUB_WORKSPACE/week_end.txt"
          echo "week_end=$WEEK_END" >> "$GITHUB_OUTPUT"
          echo "WEEK_END=$WEEK_END" >> "$GITHUB_ENV"
          echo "✓ Week ending: $WEEK_END"

      - name: Cache market candles
        uses: actions/cache@v4
        with:
          path: data/derived/market_daily
          key: market-daily-${{ runner.os }}-v1
          
      - name: Ingest market candles (required for scoring)
        run: |
          set -euo pipefail
          : "${WEEK_END:?WEEK_END not set}"
          python -m src.ingest_market_candles --universe sp500_universe.csv --week_end "${WEEK_END}"
          test -f data/derived/market_daily/candles_daily.parquet || (echo "❌ candles_daily.parquet missing after ingest" && exit 1)

      - name: Preflight – resolved artifact paths (canonical + legacy hints)
        shell: bash
        env:
          WEEK_END: ${{ steps.week_end.outputs.week_end }}
          REGIME_ID: news-novelty-v1
          SCHEMA_ID: news-novelty-v1b
        run: |
          set -euo pipefail
          echo "GIT_SHA=$(git rev-parse HEAD)"
          echo "WEEK_END=${WEEK_END}"
          echo "REGIME_ID=${REGIME_ID}"
          echo "SCHEMA_ID=${SCHEMA_ID}"
          echo "pwd=$(pwd)"

          python - <<'PY'
          from pathlib import Path
          import os

          root = Path(".").resolve()
          derived = root / "data" / "derived"

          week_end = os.environ["WEEK_END"]
          regime = os.environ["REGIME_ID"]
          schema = os.environ["SCHEMA_ID"]

          paths = {
              "features_canon": derived / "features_weekly" / f"regime={regime}" / f"schema={schema}" / f"week_ending={week_end}" / "features_weekly.parquet",
              "scores_canon":   derived / "scores_weekly"   / f"regime={regime}" / f"schema={schema}" / f"week_ending={week_end}" / "scores_weekly.parquet",
              "clusters":       derived / "news_clusters"   / f"week_ending={week_end}" / "clusters.parquet",
              "enriched":       derived / "rep_enriched"    / f"week_ending={week_end}" / "rep_enriched.parquet",
              "features_regime_only": derived / "features_weekly" / f"regime={regime}" / f"week_ending={week_end}" / "features_weekly.parquet",
              "features_flat":        derived / "features_weekly" / f"week_ending={week_end}" / "features_weekly.parquet",
              "scores_flat":          derived / "scores_weekly"   / f"week_ending={week_end}" / "scores_weekly.parquet",
              "scores_schema_only":   derived / "scores_weekly"   / f"schema={schema}" / f"week_ending={week_end}" / "scores_weekly.parquet",
          }

          print("root:", root)
          print("derived:", derived)
          for k, p in paths.items():
              print(f"{k:20s} exists={p.exists()}  path={p}")
          PY

      - name: Preflight – Python syntax check
        run: |
          set -euo pipefail
          python -m compileall -q src

      - name: Build stamp
        run: |
          set -euo pipefail
          echo "GIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "RUN_ID=${{ github.run_id }}" >> $GITHUB_ENV
          echo "RUN_ATTEMPT=${{ github.run_attempt }}" >> $GITHUB_ENV
          echo "RUN_TRIGGER=${{ github.event_name }}" >> $GITHUB_ENV
          echo "WEEK_END_REQUESTED=${{ github.event.inputs.week_end }}" >> $GITHUB_ENV
          echo "RUN_STARTED_UTC=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV

      - name: Verify required secrets present
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -euo pipefail
          test -n "${FINNHUB_API_KEY}" || (echo "❌ FINNHUB_API_KEY secret missing" && exit 1)
          test -n "${OPENAI_API_KEY}" || (echo "❌ OPENAI_API_KEY secret missing" && exit 1)
          echo "✓ Required secrets present"

      - name: Run weekly pipeline (canonical orchestrator) 
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          WEEK_END: ${{ steps.week_end.outputs.week_end }}
          REGIME_ID: news-novelty-v1
          SCHEMA_ID: news-novelty-v1b
        run: |
          set -euxo pipefail
          echo "=== Running week_end=${WEEK_END} REGIME_ID=${REGIME_ID} SCHEMA_ID=${SCHEMA_ID} ==="

          # satisfy week_end mismatch guard (same pattern as backfill)
          echo "${WEEK_END}" > week_end.txt
          cat week_end.txt

          python -m src.run_weekly_pipeline \
            --week_end "${WEEK_END}" \
            --universe sp500_universe.csv \
            --regime "${REGIME_ID}" \
            --schema "${SCHEMA_ID}" \
            --from_stage "candles"
        
      - name: Verify candles max date (pre-eval)
        run: |
          set -euo pipefail
          python - <<'PY'
          import pandas as pd
          p = "data/derived/market_daily/candles_daily.parquet"
          df = pd.read_parquet(p, columns=["date"])
          print("candles_daily max:", pd.to_datetime(df["date"]).max())
          PY
    
      - name: Evaluate hypothesis (artifact-only)
        env:
          WEEK_END: ${{ steps.week_end.outputs.week_end }}
          REGIME_ID: news-novelty-v1
          SCHEMA_ID: news-novelty-v1b
        run: |
          set -euo pipefail
          python -m src.evaluate_hypothesis \
            --schema "${SCHEMA_ID}" \
            --regime "${REGIME_ID}" \
            --weeks "${WEEK_END}" \
            --top_n 10 \
            --bottom_n 10 \
            --horizons 5,10,20


      - name: Backtest (single week_end)
        env:
          WEEK_END: ${{ steps.week_end.outputs.week_end }}
          REGIME_ID: news-novelty-v1
          SCHEMA_ID: news-novelty-v1b
        run: |
          set -euo pipefail
          : "${WEEK_END:?WEEK_END not set}"
          python src/backtest_weekly.py \
            --universe ./sp500_universe.csv \
            --from_week_end "${WEEK_END}" \
            --to_week_end "${WEEK_END}" \
            --regime "${REGIME_ID}" \
            --schema "${SCHEMA_ID}" \
            --top_n 20 \
            --sector_cap 5 \
            --tc_bps 30
          test -f data/derived/backtest/bt_weekly.parquet || (echo "❌ bt_weekly.parquet missing after backtest" && exit 1)

      - name: Evaluate complete weeks (backtest vs candles)
        env:
          WEEK_END: ${{ steps.week_end.outputs.week_end }}
        run: |
          set -euo pipefail
          mkdir -p data/derived/analysis
          python -m src.research.eval_complete_weeks \
            --bt data/derived/backtest/bt_weekly.parquet \
            --candles data/derived/market_daily/candles_daily.parquet \
            --out_dir data/derived/analysis
          test -f data/derived/analysis/evaluation_complete_weeks.md || (echo "❌ evaluation_complete_weeks.md missing" && exit 1)
          test -f data/derived/analysis/perf_complete_weeks.csv || (echo "❌ perf_complete_weeks.csv missing" && exit 1)
          test -f data/derived/analysis/perf_summary.json || (echo "❌ perf_summary.json missing" && exit 1)

      - name: Verify evaluation artifacts exist
        env:
          WEEK_END: ${{ steps.week_end.outputs.week_end }}
        run: |
          set -euo pipefail
          test -f "data/derived/analysis/hypothesis_eval/week_ending=${WEEK_END}/evaluation.md"
          test -f "data/derived/analysis/hypothesis_eval/summary.csv"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trader-sheet-and-report
          path: |
            week_end.txt

            # Forensics (keep per-week raw-ish artifacts)
            data/derived/company_news/week_ending=${{ steps.week_end.outputs.week_end }}/**
            data/derived/news_clusters/week_ending=${{ steps.week_end.outputs.week_end }}/**
            data/derived/rep_enriched/week_ending=${{ steps.week_end.outputs.week_end }}/**
            data/derived/features_weekly/**/week_ending=${{ steps.week_end.outputs.week_end }}/**
            data/derived/scores_weekly/**/week_ending=${{ steps.week_end.outputs.week_end }}/**

            # Evaluation outputs (complete-weeks report)
            data/derived/analysis/evaluation_complete_weeks.md
            data/derived/analysis/perf_complete_weeks.csv
            data/derived/analysis/perf_summary.json
            data/derived/analysis/weeks_eval_complete.txt
            data/derived/analysis/weeks_eval_incomplete.txt

            # Outputs / reporting
            data/derived/trader_sheets/**
            data/derived/reports/**
            data/derived/baskets/**
            data/derived/analysis/hypothesis_eval/**
            data/live/scoreboard.csv
            data/live/weeks_log.csv
          if-no-files-found: warn

