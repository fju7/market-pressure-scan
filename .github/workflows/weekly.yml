name: Weekly Market Pressure Scan

on:
  schedule:
    - cron: "5 21 * * 5"  # 4:05pm ET during Standard Time (EST, UTC-5) => 21:05 UTC
  workflow_dispatch: {}

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Compute week_end (last Friday ET)
        id: week_end
        run: |
          python - <<'PY'
          import datetime as dt
          import os
          from zoneinfo import ZoneInfo
          now = dt.datetime.now(ZoneInfo("America/New_York")).date()
          # Monday=0 ... Sunday=6 ; Friday=4
          days_since_fri = (now.weekday() - 4) % 7
          week_end = now - dt.timedelta(days=days_since_fri)
          print(f"week_end={week_end.isoformat()}")
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"week_end={week_end.isoformat()}\n")
          PY

      - name: Run weekly pipeline
        env:
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python -m src.run_weekly_pipeline --week_end ${{ steps.week_end.outputs.week_end }} --max_clusters_per_symbol 1 --skip_backtest
          python -m src.update_weekly_pnl --week_end ${{ steps.week_end.outputs.week_end }}
          python -m src.scoreboard
          python -m src.trader_sheet --week_end ${{ steps.week_end.outputs.week_end }}
          python -m src.log_week_decision --week_end ${{ steps.week_end.outputs.week_end }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trader-sheet-and-report
          path: |
            data/derived/trader_sheets/**
            data/derived/reports/**
            data/derived/baskets/**
            data/live/scoreboard.csv

      - name: Create notification issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const week_end = '${{ steps.week_end.outputs.week_end }}';
            const status = '${{ job.status }}';
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            const fs = require('fs');
            
            // Read scoreboard
            let scoreboardSnippet = 'Scoreboard not available';
            try {
              const scoreboard = fs.readFileSync('data/live/scoreboard.csv', 'utf8');
              const lines = scoreboard.split('\n').slice(0, 10);
              scoreboardSnippet = '```\n' + lines.join('\n') + '\n```';
            } catch (e) {
              scoreboardSnippet = 'Could not read scoreboard';
            }
            
            // Read trader sheet for action + top symbols
            let actionDecision = 'UNKNOWN';
            let topSymbols = 'Not available';
            let basketSize = 0;
            let overlapPct = null;
            let turnoverPct = null;
            
            try {
              const traderSheet = fs.readFileSync(`data/derived/trader_sheets/week_ending=${week_end}/trader_sheet.csv`, 'utf8');
              const lines = traderSheet.split('\n');
              
              // Extract action from header comments or determine from content
              const hasData = lines.length > 1 && lines[1].trim().length > 0;
              actionDecision = hasData ? 'ðŸ“ˆ TRADE' : 'â¸ï¸ SKIP';
              
              // Get top 5 symbols and count basket size
              if (hasData) {
                const symbols = lines.slice(1, 6)
                  .filter(line => line.trim())
                  .map(line => {
                    const cols = line.split(',');
                    const ticker = cols[0] || '?';
                    const ups = cols[1] || '?';
                    const conviction = cols[2] || '?';
                    return `${ticker} (UPS: ${ups}, ${conviction})`;
                  });
                topSymbols = symbols.join('\n');
                basketSize = lines.slice(1).filter(line => line.trim()).length;
              } else {
                topSymbols = 'Low-information week: No trades';
              }
            } catch (e) {
              topSymbols = `Could not read trader sheet: ${e.message}`;
            }
            
            // Read weeks_log for turnover metrics
            try {
              const weeksLog = fs.readFileSync('data/live/weeks_log.csv', 'utf8');
              const lines = weeksLog.split('\n');
              const currentWeekLine = lines.find(line => line.includes(week_end));
              
              if (currentWeekLine) {
                const cols = currentWeekLine.split(',');
                // Assuming CSV columns: week_ending_date,action,basket_size,overlap_pct,turnover_pct,...
                basketSize = parseInt(cols[2]) || basketSize;
                overlapPct = parseFloat(cols[3]);
                turnoverPct = parseFloat(cols[4]);
              }
            } catch (e) {
              // Weeks log might not exist yet or metric not available
            }
            
            const body = `@fju7 â€” Your weekly market pressure scan is ready!
            
            ## ðŸ“Š Weekly Market Pressure Scan Complete
            
            **Week Ending:** ${week_end}
            **Status:** ${status === 'success' ? 'âœ… Success' : 'âŒ Failed'}
            **Basket Size:** ${basketSize}${overlapPct !== null ? `\n**Overlap:** ${overlapPct.toFixed(1)}% | **Turnover:** ${turnoverPct.toFixed(1)}%` : ''}
            
            ### ${actionDecision}
            
            **Top 5 UPS Signals:**
            \`\`\`
            ${topSymbols}
            \`\`\`
            
            ### Quick Stats
            ${scoreboardSnippet}
            
            ### ðŸ”— Links
            - **[ðŸ“¥ View Run & Download Artifacts](${runUrl})**
            - Artifacts include: Trader Sheet, Weekly Report, Basket, Scoreboard
            
            ---
            *This issue auto-closes in 7 days*`;
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“ˆ Weekly Scan: ${week_end}`,
              body: body,
              labels: ['weekly-scan', 'automated']
            });
            
            // Schedule auto-close in 7 days
            const closeDate = new Date();
            closeDate.setDate(closeDate.getDate() + 7);
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.data.number,
              body: `ðŸ¤– This issue will auto-close on ${closeDate.toISOString().split('T')[0]}`
            });
            
            // Return issue number for potential auto-close step
            return issue.data.number;

      - name: Schedule issue auto-close
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const week_end = '${{ steps.week_end.outputs.week_end }}';
            
            // Find the issue we just created
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'weekly-scan',
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 1
            });
            
            if (issues.data.length > 0) {
              const issue = issues.data[0];
              const createdDate = new Date(issue.created_at);
              const now = new Date();
              const daysOld = (now - createdDate) / (1000 * 60 * 60 * 24);
              
              // Close issues older than 7 days
              const oldIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'weekly-scan',
                state: 'open',
                per_page: 100
              });
              
              for (const oldIssue of oldIssues.data) {
                const created = new Date(oldIssue.created_at);
                const age = (now - created) / (1000 * 60 * 60 * 24);
                
                if (age >= 7) {
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: oldIssue.number,
                    state: 'closed'
                  });
                  
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: oldIssue.number,
                    body: 'ðŸ¤– Auto-closed after 7 days'
                  });
                }
              }
            }
